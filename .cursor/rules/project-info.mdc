---
description: 仓库详情
globs: *.*
---
【1. src/extension/content.js】  
• 主要作用：  
  – 实现侧边栏的内容脚本逻辑，是注入到所有网页中的扩展内容部分。  
  – 定义了类似 “CerebrSidebar” 这样的类（或构造函数），负责管理侧边栏的创建、初始化、更新尺寸、位置、全屏状态以及URL变化监听等。  

• 重要组件与功能：  
  – 构造函数中初始化各种状态（如 scaleFactor、initialized、lastUrl、isFullscreen、sidebarPosition 等），确保侧边栏在文档中正确渲染。  
  – 方法如 updateWidth(width) 和 updatePosition(position) 用于更新侧边栏的宽度和定位；内部会调用 chrome.storage.sync 将设置持久化。  
  – 处理全屏模式下的特殊逻辑（例如，在全屏模式下不改变侧边栏位置）。  
  – 设置 URL 变化监听器（setupUrlChangeListener）与拖放处理（setupDragAndDrop）；通过监听 URL 变化来通知后台或触发其他模块更新。  

• 依赖与耦合：  
  – 与 chrome.runtime 和 chrome.storage 等 Chrome API 紧密耦合，用于消息传递和存储设置。  
  – 与侧边栏的 UI 样式和动画紧密相关（例如，通过设置 CSS 自定义属性实现动画效果和阴影）；其逻辑与 src/ui/sidebar/sidebar.html 中定义的DOM结构保持耦合。  
  – 可能与 background.js 之间通过消息通信协商（例如，部分消息类型需要依赖后台发送的响应）。

─────────────────────────────  
【2. src/core/message_sender.js】  
• 主要作用：  
  – 定义 createMessageSender(options) 工厂函数，负责构建并发送用户消息到后端API。  
  – 集中处理消息的构建、调取提示词、处理图片、临时模式逻辑以及请求发送与流式响应的处理。  

• 重要组件与功能：  
  – 验证 API 配置（validateApiConfig）：确保 API 密钥、base URL 等必填项。  
  – getPageContent()：通过 chrome.runtime.sendMessage 请求侧边栏外的页面内容。  
  – sendMessage(options)：获取用户输入、解析注入系统消息、判空检查、添加 loading 状态、调用 buildMessages() 组装消息数组，然后构造完整请求体（apiManager.buildRequest）并发送请求。  
  – 处理流式响应（handleStreamResponse）：循环读取 response.body 中的令牌，更新 AI 消息显示。  
  – 封装了临时模式（enterTemporaryMode/exitTemporaryMode）和中止请求（abortCurrentRequest）的逻辑，方便用户操作。  
  – 同时将用户消息的附加元数据（如注入系统消息、提示词类型、所用的 API 配置）保存到对应的 DOM 元素属性中，便于后续重新生成。  

• 依赖与耦合：  
  – 强依赖于 apiManager（来自 src/api/api_settings.js）来构造请求及获取配置；  
  – 依赖 messageProcessor（来自 src/core/message_processor.js）来格式化和更新消息显示；  
  – 依赖 imageHandler（来自 src/utils/image_handler.js）处理图片相关逻辑；  
  – 与 chatHistoryUI（来自 src/ui/chat_history_ui.js）联合使用，保存会话及更新历史记录；  
  – 用了 chrome.runtime.sendMessage 与 storage.sync（同 content.js）进行跨模块数据传递；  
  – 在调用 buildMessages() 时还涉及对 prompt 设置（通过 getPrompts() 提供，来自 prompt_settings 模块或 settings_manager）等的联合处理。

─────────────────────────────  
【3. src/extension/background.js】  
• 主要作用：  
  – 作为扩展的后台 Service Worker 脚本，负责监听扩展安装、激活、命令调用与消息传递。  
  – 主要用于处理浏览器命令（如 open_sidebar、close_sidebar、capture_screenshot、toggle_fullscreen）、右键菜单点击、持久连接与后台心跳机制。  

• 重要组件与功能：  
  – 安装（install）和激活（activate）监听器，确保 Service Worker 快速跳过等待并取得控制权。  
  – chrome.commands.onCommand 监听器：当用户使用快捷键时，根据命令调用 handleTabCommand()，进而通过 chrome.tabs.sendMessage 通知当前标签页。  
  – 处理扩展图标点击（chrome.action.onClicked），发送 TOGGLE_SIDEBAR_onClicked 消息给内容脚本。  
  – 处理持久连接：通过 chrome.runtime.onConnect 与端口管理，实现长连接重连逻辑。  
  – 监听 chrome.runtime.onMessage，为特定消息类型（比如 GET_PAGE_CONTENT_FROM_SIDEBAR、downloadPDF、capture_visible_tab）提供应答或重试逻辑。  
  – 管理 PDF 下载和分块，通过 getPDFArrayBuffer、downloadPDF、getPDFChunk 等函数处理网络或本地 PDF 文件。  
  – 监听 chrome.webRequest 事件（onBeforeRequest、onCompleted、onErrorOccurred）跟踪标签页请求，向内容脚本发送请求状态更新。  
  – 设置右键菜单（contextMenus.create）及其点击事件。  

• 依赖与耦合：  
  – 和 chrome.tabs、chrome.commands、chrome.runtime 及 chrome.webRequest 等 Chrome API 紧密相关；  
  – 与内容脚本（src/extension/content.js）实现消息通信；  
  – 与后续 PDF 下载、标签页连接检查等逻辑存在耦合，依赖 isTabConnected 等内部方法。  
  – 处于整个扩展的全局控制层，与其他 UI 模块（侧边栏）通过消息传递相互配合，同时相对独立于页面内工作。

─────────────────────────────  
【4. src/ui/sidebar/sidebar.js】  
• 主要作用：  
  – 初始化并管理侧边栏整个用户界面。负责从 DOM 元素的获取、事件监听、模块实例的创建到整体交互逻辑。  
  – 将各个子模块（聊天历史、消息处理、图片处理、API管理、设置管理、UI管理、上下文菜单管理）组合起来，共同构成扩展的主要用户呈现界面。  

• 重要组件与功能：  
  – DOM 元素获取：获取聊天容器、输入框、各类按钮、设置菜单、API设置面板、提示词设置面板等。  
  – 初始化各模块：分别调用 createChatHistoryManager、createMessageProcessor、createImageHandler、createMessageSender、createContextMenuManager、createSettingsManager。  
  – 事件监听：为发送按钮、消息输入框（包括键盘、拖放、粘贴事件）、全屏切换按钮、菜单项等添加交互事件；同时监听 window.postMessage 接收来自外部及 content script 的消息。  
  – 管理全局状态：维护全屏状态、输入法状态、以及聊天历史面板与菜单状态的切换。  
  – 包含一些辅助函数（如 scrollToBottom、closeExclusivePanels），并在后期传递给其他模块作为依赖。  

• 依赖与耦合：  
  – 与 chatHistoryUI、messageSender、messageProcessor、imageHandler、uiManager、settingsManager、apiManager、contextMenuManager 等众多模块高度耦合，形成一个模块化但又紧密协同的整体；  
  – 依赖 chrome.runtime、window.postMessage 等消息传递机制以实现与 background 与内容脚本间的联动。  
  – DOM结构（见 sidebar.html）和 CSS 样式直接决定了各个模块的呈现，因此与样式文件（如 sidebar.css）紧密相关，同时需要确保内部模块接口一致。

─────────────────────────────  
【5. src/ui/settings_manager.js】  
• 主要作用：  
  – 管理侧边栏与整体扩展的用户界面设置，包括主题、侧边栏宽度、字体大小、缩放比例、自动滚动、划词搜索清空聊天历史、发送聊天历史、引用显示、侧边栏位置等。  
  – 通过 chrome.storage.sync 获取和保存这些设置，并更新 DOM 样式（如 CSS 自定义属性）和相关 UI 元素。  

• 重要组件与功能：  
  – 定义 DEFAULT_SETTINGS，其中包含 theme、sidebarWidth、fontSize、scaleFactor 等初始值。  
  – initSettings()：加载设置，合并默认值与已保存值，然后调用 applyAllSettings() 将设置应用到 UI 上。  
  – 各种 applyXxx 函数：applyTheme、applySidebarWidth、applyFontSize、applyScaleFactor、applyAutoScroll、applyClearOnSearch、applySendChatHistory、applyShowReference、applySidebarPosition，负责将新值设置到 document.documentElement 的 CSS 变量或直接修改 DOM 控件的数值。  
  – 事件绑定：在 setupEventListeners() 中为各个滑块、开关和下拉框添加监听器，实时更新设置并保存到 chrome.storage 同步。  
  – 与父窗口通信：例如，通知侧边栏宽度或缩放变化给父窗口。  
  – 依赖 createThemeManager() 来管理并应用主题，通过更新 themeSwitch、themeSelect 等相关组件。  

• 依赖与耦合：  
  – 与 chrome.storage.sync 强耦合，用于持久化用户设置。  
  – 与 theme_manager.js 紧密配合，负责主题的实际应用与预览渲染。  
  – 依赖 UI 元素（通过 getElementById）与 window.cerebr.settings 对象共享数据，为侧边栏（由 sidebar.js 加载）的外观和行为提供配置；  
  – 在设置变更时还会通知父窗口（通过 postMessage），与整体扩展的多模块交互保持耦合。

─────────────────────────────  
【6. src/core/message_processor.js】  
• 主要作用：  
  – 处理所有消息的显示和更新工作，将原始文本转换为渲染后的 HTML。  
  – 负责处理 Markdown 解析、数学公式处理（利用 katex 和 auto-render）、代码块语法高亮（highlight.js）、以及消息中引用标记和来源信息的插入。  

• 重要组件与功能：  
  – appendMessage(text, sender, …)：动态创建消息 DOM 元素，支持同时附带图片区域，保存原始文本到 data-original-text 属性，并调用 processMathAndMarkdown 处理文本。  
  – updateAIMessage(aiResponse, groundingMetadata)：实时更新 AI 消息，当有新令牌到达时，追加文本、重新渲染 Markdown、代码块和公式，并在必要时将 groundingMetadata 的引用标记替换为实际的 HTML 元素。  
  – processMathAndMarkdown(text)：对文本先修正一些 Markdown 细节问题（比如“**bold**text”连写误判），再通过 marked 将 Markdown 渲染为 HTML，同时调用 katex 渲染数学公式；其中用到了预处理（preMathEscape）和后处理（postMathReplace）的逻辑。  
  – addGroundingToMessage(text, groundingMetadata)：负责将 API 返回的引用元数据信息嵌入消息文本中，替换部分文本为含有引用标记和 tooltip 的 HTML。  
  – 其他辅助函数包括 extractSystemContent（提取系统消息部分），fixBoldParsingIssue 和 foldMessageContent 等。  

• 依赖与耦合：  
  – 强依赖 marked、hljs、katex、auto-render 等第三方库，用于文本/公式解析与代码块高亮。  
  – 与 chatContainer、chatHistory、addMessageToTree 等由侧边栏和聊天历史模块提供的 DOM 和数据结构紧密耦合。  
  – 被 messageSender 在发送消息过程中调用，以保证发送前后的消息格式与展示一致；  
  – 部分 grounding 相关逻辑与从 API 返回的数据结构耦合，要求 API 返回的数据格式符合预期。

─────────────────────────────  
【7. src/ui/chat_history_ui.js】  
• 主要作用：  
  – 管理侧边栏中聊天历史的显示与交互，包括加载、保存、清空、切换会话、显示摘要、更新页面信息以及内存清理。  
  – 通过与 IndexedDB 数据库（参见 indexeddb_helper.js）协同，支持对话记录的持久存储和回档。  

• 重要组件与功能：  
  – 提供 saveCurrentConversation(isUpdate) 函数，用于在消息发送完毕后保存当前会话；  
  – clearChatHistory() 用于清空对话记录，同时也提供 clearMemoryCache() 以释放内存。  
  – updatePageInfo(pageInfo) 使得页面信息（标题、URL等）能够更新到历史记录中；  
  – getConversationFromCacheOrLoad()、loadConversationIntoChat() 等函数实现从本地数据库检索并显示对话记录；  
  – 内部工具函数 formatRelativeTime、getGroupLabel 用于处理时间显示格式；  
  – 实现打开、关闭、切换聊天记录面板等交互操作。  

• 依赖与耦合：  
  – 与 IndexedDB 操作紧密相关，依赖 src/storage/indexeddb_helper.js 提供的数据库操作接口。  
  – 与 chat_history_manager.js 联合使用，用于管理会话树结构（消息节点的添加、删除、继承关系维护）。  
  – 与侧边栏整体 UI（来自 sidebar.js 与 ui_manager.js）整合，负责在用户交互时更新 DOM 显示。  
  – 调用 chrome.storage（同步设置）以及内部定时器实现内存管理与自动清理逻辑。

─────────────────────────────  
【8. src/ui/theme_manager.js】  
• 主要作用：  
  – 管理扩展的主题（配色）切换与应用，提供从主题列表获取到实际应用主题与通知变更的全部功能。  
  – 允许用户通过 settings_manager 或提示词设置中选择不同主题，同时根据系统配色方案自动调整。  

• 重要组件与功能：  
  – getAvailableThemes()：返回可用主题列表；  
  – getThemeById(themeId) 与 applyTheme(themeId)：分别用于查找与应用某个主题，实际将 CSS 变量或类名设到 document.documentElement 上。  
  – notifyThemeChange(themeId)：当主题发生变化时，向其他模块（例如 settings_manager）通知更新。  
  – renderThemePreview(container, onThemeSelect)：在设置页面内显示主题预览卡片，并支持点击选择；  
  – init(initialThemeId) 初始化主题管理器，可能结合 window.matchMedia 监听系统主题变化。  

• 依赖与耦合：  
  – 与 settings_manager.js 紧密耦合，后者调用其函数来应用主题设置；  
  – 与侧边栏 HTML 结构及 CSS 样式关联紧密，依赖于 CSS 自定义属性和特定类（如 dark-theme 等）来改变外观；  
  – 通过 window.dispatchEvent 与全局事件通知其他模块。

─────────────────────────────  
【9. src/storage/indexeddb_helper.js】  
• 主要作用：  
  – 为聊天记录的本地持久化存储提供 IndexedDB 封装，包括数据库的打开、升级、对话记录和消息内容的存取。  

• 重要组件与功能：  
  – openChatHistoryDB()：打开或创建名为 "ChatHistoryDB" 的数据库，同时创建两个对象存储“conversations”（对话元数据）和 “messageContents”（大消息内容分离存储）。  
  – getAllConversationMetadata()：获取全部对话记录但不包含详细消息内容，用以显示摘要。  
  – getAllConversations(loadFullContent) ：根据 loadFullContent 参数决定是否从“messageContents”中加载完整文本。  
  – putConversation(conversation, separateContent) ：在保存时将大型消息内容分离存储，并在对话对象中用引用替换实际内容。  
  – deleteConversation(conversationId) ：删除整个对话记录，同时清除分离存储的消息内容。  
  – 附加函数 attachContentToMessage(msg, contentStore) 为消息解引用。  
  – 另外提供 getConversationById、loadMessageContent、releaseConversationMemory 与 getDatabaseStats 等辅助接口。  

• 依赖与耦合：  
  – 与 IndexedDB API 紧密耦合，是整个扩展中保存聊天记录的核心模块。  
  – 被 chat_history_ui.js 和 chat_history_manager.js 调用，用于持久化与恢复历史会话。  
  – 程序内的 put、get 与 delete 操作与存储对象名称、版本号都有固定耦合关系，需要与数据结构保持一致。

─────────────────────────────  
【10. src/ui/ui_manager.js】  
• 主要作用：  
  – 统一管理侧边栏中各个全局 UI 交互，如输入框高度调整、发送按钮的启用/禁用、菜单的切换、面板的关闭及焦点控制等。  

• 重要组件与功能：  
  – adjustTextareaHeight(textarea)：自动根据内容改变文本框高度；resetInputHeight() 用于重置输入框高度。  
  – updateSendButtonState()：检测输入框及是否有图片标签，更新发送按钮的 disabled 状态。  
  – toggleSettingsMenu(show)：显示或隐藏设置菜单；closeExclusivePanels() 用于关闭所有互斥面板。  
  – setupInputEventListeners()：绑定输入框（包括粘贴、drop 等事件）的事件处理函数，保证输入时的行为统一。  
  – setupSettingsMenuEventListeners()、setupPanelEventListeners()、setupChatContainerEventListeners()、setupFocusEventListeners() 分别为不同区域（设置菜单、面板、聊天容器、焦点控件）添加监听，确保全局 UI 状态协同。  

• 依赖与耦合：  
  – 与 DOM 的实际结构紧密耦合，依赖页面中各个元素的存在和 ID 命名（如 message-input、settings-menu 等）。  
  – 和侧边栏的其他模块（例如 messageSender、chatHistoryUI）通过传递的回调（如 setShouldAutoScroll）互相协作。  
  – 功能上独立于业务逻辑，但作为视图层的调度器，与 settings_manager、api_manager、context_menu_manager 均有间接关联。

─────────────────────────────  
【11. src/api/api_settings.js】  
• 主要作用：  
  – 管理 API 配置及请求的相关逻辑，是扩展连接到外部 AI API 的配置层。  
  – 负责加载、保存、渲染 API 配置卡片，允许用户对 API Key、Base URL、模型名称、temperature、及自定义参数进行设置、复制、删除等操作。  
  – 提供 buildRequest() 和 sendRequest() 用于构造请求体和实际发起网络请求。  

• 重要组件与功能：  
  – loadAPIConfigs() 从 chrome.storage.sync 中读取配置；若没有则创建一个默认配置；随后存储到全局 window.apiConfigs 中，并触发更新事件。  
  – createAPICard(config, index, templateCard)：通过复制 DOM 模板生成卡片，添加选择、复制、收藏、删除动作；内含对密码隐藏、切换显示（togglePasswordBtn）的处理。  
  – renderAPICards() 与 renderFavoriteApis()：分开负责渲染全部及已收藏的 API 配置卡片。  
  – buildRequest({messages, config, overrides}) 构造调用外部API所需的请求体，根据配置合并自定义参数。  
  – sendRequest({requestBody, config, signal}) 基于 fetch 发起网络 POST 请求；并支持中止 signal。  
  – setupUIEventHandlers(apiSettingsToggle, backButton) 绑定 API 设置面板的显示和返回操作。  
  – 另外提供 getModelConfig() 和 getApiConfigFromPartial() 作为从当前配置集合中查询合适模型的辅助函数。  

• 依赖与耦合：  
  – 与 chrome.storage.sync 历史存储紧密耦合；  
  – 与侧边栏中的 API 设置面板 DOM（位于 sidebar.html 中）直接对应，需要预先定义好的卡片模板；  
  – 和全局 window.apiConfigs 存在依赖，受到其他模块（如 prompt_settings）对模型名称调用；  
  – 与 message_sender 之间存在依赖，发送消息时可能会从这里获取针对特定提示词类型的模型配置。

─────────────────────────────  
【12. src/ui/sidebar/sidebar-message-handler.js】  
• 主要作用：  
  – 作为侧边栏内的消息监听和处理模块，专门监听来自 content script 的 window.postMessage 消息。  
  – 处理 URL 变化后通知重新获取内容（通过模拟关闭再打开“网页问答”开关）以及收到了“清空聊天记录”命令时触发对应按钮。  
  – 同时管理用户问题历史记录，用于实现当用户按上方向键重新填充历史消息的功能。  

• 重要组件与功能：  
  – 监听 window “message” 事件，根据 event.data.type（如 URL_CHANGED、CLEAR_CHAT_COMMAND）执行针对性逻辑；  
  – 当 URL 变化时，检查“网页问答”开关状态，对开关先置为 false 再重置为 true以触发对应的 change 事件，实现“重新获取页面内容”的逻辑；  
  – 记录用户问题历史（userQuestions 数组），在 DOMContentLoaded 时初始化并通过 MutationObserver 监听新增的 .user-message 元素；  
  – 当输入框为空且按上键时自动填充最后一个用户问题。  

• 依赖与耦合：  
  – 与 DOM 中的 #message-input、#clear-chat 按钮以及 .user-message 结构耦合；  
  – 与 chatContainer 内消息的管理有一定依赖；  
  – 与 sidebar.html 定义的整体侧边栏结构和其他 UI 组件形成交互；  
  – 另外通过 window.postMessage 与扩展内其他模块（如 background 和 content 脚本）通信，保持整体交互一致。

─────────────────────────────  
【13. src/core/chat_history_manager.js】  
• 主要作用：  
  – 定义聊天历史记录的核心数据结构和管理逻辑，以树状结构保存会话历史。  
  – 提供创建消息节点、添加消息到树中、寻找父子关系、获取当前会话链以及清空或删除单条消息的功能。  

• 重要组件与功能：  
  – createMessageNode(role, content, parentId)：创建一条消息节点，包含唯一ID、角色、内容、父节点、子节点数组及时间戳。  
  – addMessageToTree(chatHistory, role, content, parentId)：将节点添加到树中，同时维护父节点的 children 数组；更新 root 与 currentNode。  
  – getCurrentConversationChain(chatHistory)：从当前节点向上回溯至根节点，生成完整消息链；  
  – deleteMessageFromHistory(chatHistory, messageId)：特殊处理删除操作，若有父节点则将删除消息的子节点再分配给父节点；若删除的是根节点则更新新根；同时更新 currentNode。  
  – 同时还提供 clearChatHistory(chatHistory) 来重置整个对话记录。  

• 依赖与耦合：  
  – 作为聊天历史的核心管理层，是高内聚、低耦合的纯数据处理模块，但依赖传入的 chatHistory 数据结构；  
  – 与 chat_history_ui.js 配合使用，为 UI 提供数据支持；  
  – 在添加消息时，createChatHistoryManager() 工厂函数将本模块与整个侧边栏会话数据融合；  
  – 与 IndexedDB 模块（indexeddb_helper.js）在持久化时存在“数据格式”上的一致性要求。

─────────────────────────────  
【14. src/core/prompt_settings.js】  
• 主要作用：  
  – 提供默认的各种提示词（system、image、selection、pdf、summary、foldPattern、foldSummary）的设置与管理。  
  – 定义 PromptSettings 类，通过关联提示词设置面板的 DOM 元素，实现加载、保存、自动保存、重置到默认值以及实时更新提示词设置。  

• 重要组件与功能：  
  – DEFAULT_PROMPTS 对象：保存各个类型默认提示词字符串和默认的“模型”配置（大多为 'follow_current'，说明跟随当前 API 设置）。  
  – PromptSettings 构造函数：获取页面中提示词相关的 DOM 控件（各个 textarea、下拉框、重置按钮等），并调用 initModelSelects() 初始化各提示词对应的模型选择；调用 bindEvents() 绑定返回、重置、保存等按钮事件；调用 loadPromptSettings() 从 chrome.storage.sync 加载设置（或恢复默认）。  
  – 方法 autoSavePromptSettings() 与 savePromptSettings() 实现提示词实时保存和手动保存。  
  – collectCurrentPromptSettings() 读取当前文本框和模型选择，构造最终保存的提示词设置对象。  
  – resetPrompts() 和 resetSinglePrompt() 用于恢复默认值，并触发 UI 的轻微动画反馈。  

• 依赖与耦合：  
  – 与 chrome.storage.sync 耦合，用于持久化保存提示词；  
  – 与侧边栏中提示词设置面板（位于 sidebar.html 中）及其 CSS 样式紧密相关；  
  – 与 settings_manager.js 中的全局设置、window.apiConfigs 以及全局事件（如 promptSettingsUpdated 事件）交互；  
  – 作为核心的提示词配置模块，其输出（通过 getPrompts()）将直接被 message_sender.js 调用，进而影响 API 请求的构造和消息生成。

─────────────────────────────  
【15. src/utils/image_handler.js】  
• 主要作用：  
  – 封装与图片相关的所有操作，包含图片预览、创建图片标签、处理拖放和粘贴图片等。  
  – 为侧边栏输入区域提供图片附加、预览和删除功能，确保用户能够方便地将图片插入到聊天中。  

• 重要组件与功能：  
  – showImagePreview(base64Data) 与 hideImagePreview()：分别用于显示和隐藏预览模态框。  
  – initImagePreviewEvents()：绑定关闭按钮和预览模态框的点击事件，实现点击空白处关闭。  
  – processImageTags(content, imagesHTML)：读取图片标签 HTML，并将文本和图片组合为特殊格式（数组或纯文本），便于存入消息记录。  
  – createImageTag(base64Data, fileName)：构造一个含有缩略图和删除按钮的 image-tag DOM 元素；同时绑定预览和删除事件。  
  – addImageToContainer()：将生成的 image-tag 添加到指定容器，并触发输入事件以促使 UI 刷新。  
  – handleImageDrop(e, target) 与 setupImageDropListeners(elements)：处理用户拖放图片文件或链接进输入框或聊天容器的行为。  

• 依赖与耦合：  
  – 与 DOM 操作密切相关，要求 messageInput、imageContainer、预览模态框等在 sidebar.html 中定义；  
  – 被 sidebar.js 与 ui_manager.js 调用，为消息发送和输入框事件提供图片支持；  
  – 无论在纯功能上均采用函数式编程风格（纯函数尽量多），与其他模块做到内聚独立。

─────────────────────────────  
【16. src/ui/sidebar/sidebar.html】  
• 主要作用：  
  – 页面结构文件，定义侧边栏扩展的整体 HTML 结构。  
  – 包括主要的聊天区域、输入区、上下文菜单、设置菜单、API 设置面板和提示词设置面板等。  
  – 同时内嵌（或引用）了大量 CSS 样式文件（如 sidebar.css、github-dark.css、katex.min.css）和 JavaScript 库（marked, highlight, katex, auto-render, purify），以保证正确渲染复杂内容。  

• 重要组件与功能：  
  – DOM 结构部分：  
    ∟ #collapse-button 用于折叠侧边栏；  
    ∟ #chat-container 显示聊天记录；  
    ∟ #context-menu 定义消息右键菜单，包括复制消息、复制代码、停止更新、删除消息、重新生成、清空聊天等选项；  
    ∟ #input-container 包含图片容器 (#image-container) 与消息输入框 (#message-input)，同时包含截屏、发送按钮。  
    ∟ #settings-container 内置设置按钮和包含多个选项（自动滚动、清空聊天、发送聊天历史、显示引用标记、侧栏位置等）的设置菜单；  
    ∟ #api-settings 区域包含 API 设置面板，其内部有模板卡片 (.api-card.template) 供复制生成；  
    ∟ #prompt-settings 包含提示词设置面板，内含各个 prompt 文本框和对应的模型选择、重置及保存按钮。  
    ∟ 图片预览模态框 (.image-preview-modal) 用于预览大图。  
  – 脚本引用：页面底部引入所有必需的 JS 模块，如 sidebar.js 和 sidebar-message-handler.js，保证页面加载后执行初始化。  

• 依赖与耦合：  
  – 是整个侧边栏扩展的容器，与所有 JS 模块（侧边栏逻辑、消息处理、设置管理、API设置、图片处理、聊天记录管理、提示词设置等）都有直接依赖。  
  – HTML 中的各个 DOM 元素 ID 和 class 需要和 ui_manager.js、settings_manager.js、message_sender.js 等模块保持一致，因此具有较高的内聚性和模块间约定。  
  – 同时依赖外部 CSS 文件和第三方 JS 库，构成完整的前端展现和交互体系。

─────────────────────────────  
总结：  
整个项目以 Chrome 扩展为载体，实现一个基于 AI 聊天助手的侧边栏，整体采用模块化设计。各个文件之间遵循低耦合高内聚的原则：  
  – 核心业务模块（如 message_sender.js、message_processor.js、chat_history_manager.js、prompt_settings.js）主要负责数据处理与消息构建；  
  – UI 管理模块（sidebar.js、ui_manager.js、chat_history_ui.js、settings_manager.js、theme_manager.js）负责 DOM 操作和用户交互，彼此之间通过回调和全局事件进行协同；  
  – API 及存储模块（api_settings.js、indexeddb_helper.js）用于与外部 API 通信和本地会话持久化；  
  – 工具类模块（image_handler.js）则分离出图片相关的处理，让各模块专注于自身业务。  
侧边栏的 HTML 文件作为整体入口，通过引用各个 JS 文件构成完整的扩展界面。各模块之间的依赖关系清晰：例如，message_sender 依赖 message_processor、api_manager 和 chat_history_ui；settings_manager 又依赖 theme_manager；而所有数据存储操作都整合在 indexeddb_helper.js 中。整个架构既分层又划分明确，同时通过 chrome.runtime、chrome.storage 和 postMessage 等机制实现跨模块与跨页面通信，从而构成了一个功能强大、灵活可配置的 Chrome 扩展。
