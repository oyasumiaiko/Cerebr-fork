<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cerebr</title>
    <script src="/lib/marked.min.js"></script>
    <script src="/lib/highlight.min.js"></script>
    <script src="/lib/lean.min.js"></script>
    <script src="/lib/katex.min.js"></script>
    <script src="/lib/auto-render.min.js"></script>
    <script src="/lib/purify.min.js"></script>
    <script src="/lib/dom-to-image-more.min.js"></script>
    <!-- <script src="/lib/cytoscape.min.js"></script>
    <script src="/lib/dagre.min.js"></script>
    <script src="/lib/cytoscape-dagre.js"></script> -->

    <link rel="stylesheet" href="/lib/fontawesome/css/all.css">
    <link rel="stylesheet" href="/lib/github-dark.css">
    <link rel="stylesheet" href="/lib/katex.min.css">
    <link rel="stylesheet" href="/src/ui/styles/sidebar.css">
</head>
<body>
    <div id="collapse-button" role="button" tabindex="0" title="切换全屏/侧栏" aria-label="切换全屏/侧栏"></div>
    <div id="chat-layout">
        <div id="chat-container"></div>
        <div id="thread-panel" aria-hidden="true">
            <div id="thread-container"></div>
        </div>
        <div id="thread-splitter" aria-hidden="true"></div>
        <div id="thread-resize-edge-left" aria-hidden="true"></div>
        <div id="thread-resize-edge-right" aria-hidden="true"></div>
    </div>
    <div class="empty-state-content">
        <div class="empty-state-icon" style="display: none;">
            <i class="far fa-comment-dots"></i>
        </div>
        <h3 class="empty-state-title">开始对话</h3>
        <p class="empty-state-description">在下方输入您的问题，或者尝试以下选项</p>
        <div class="empty-state-actions">
            <div id="empty-state-history" class="empty-state-action">
                <i class="far fa-box-archive"></i>
                <span>查看聊天记录</span>
            </div>
            <div id="empty-state-summary" class="empty-state-action">
                <i class="far fa-file-alt"></i>
                <span>总结当前页面</span>
            </div>
            <div id="empty-state-repomix" class="empty-state-action" style="display: none;">
                <i class="fa-brands fa-github"></i>
                <span>总结当前 GitHub 仓库</span>
            </div>
            <div id="empty-state-temp-mode" class="empty-state-action">
                <i class="far fa-comments"></i>
                <span>纯对话模式</span>
            </div>
            <div id="empty-state-page-content" class="empty-state-action">
                <i class="far fa-file-arrow-down"></i>
                <span>提取页面内容</span>
            </div>
            <div id="empty-state-random-background" class="empty-state-action">
                <i class="far fa-image"></i>
                <span>随机背景图片</span>
            </div>
            <div id="empty-state-load-url" class="empty-state-action">
                <i class="far fa-history"></i>
                <span>继续本页对话</span>
            </div>
        </div>
    </div>
    <div id="context-menu">
        <div class="context-menu-item" id="copy-code" style="display: none;">
            <i class="far fa-code"></i>
            复制代码
        </div>
        <div class="context-menu-item" id="copy-message">
            <i class="far fa-copy"></i>
            复制消息
        </div>
        <div class="context-menu-item" id="copy-as-image">
            <i class="far fa-image"></i>
            复制为图片
        </div>
        <div class="context-menu-item" id="edit-message">
            <i class="far fa-pen-to-square"></i>
            编辑消息
        </div>
        <div class="context-menu-item" id="stop-update">
            <i class="far fa-stop"></i>
            停止更新
        </div>
        <div class="context-menu-item" id="fork-conversation">
            <i class="far fa-code-branch"></i>
            创建分支
        </div>
        <div class="context-menu-item context-menu-item--has-submenu" id="regenerate-message" style="display: none;">
            <div class="context-menu-item__label context-menu-item__label--stack">
                <i class="far fa-redo"></i>
                <div class="context-menu-item__label-text">
                    <span>重新生成</span>
                    <span class="context-menu-item__hint" id="regenerate-message-api-hint"></span>
                </div>
            </div>
            <i class="far fa-chevron-right context-menu-item__arrow"></i>
            <div class="context-menu-submenu">
                <div class="context-menu-submenu-list"></div>
            </div>
        </div>
        <div class="context-menu-item context-menu-item--has-submenu" id="insert-message-menu" style="display: none;">
            <div class="context-menu-item__label">
                <i class="far fa-square-plus"></i>
                <span>在此处插入</span>
            </div>
            <i class="far fa-chevron-right context-menu-item__arrow"></i>
            <div class="context-menu-submenu">
                <div class="context-menu-submenu-list">
                    <div class="context-menu-submenu-item" data-insert-type="both">同时插入</div>
                    <div class="context-menu-submenu-item" data-insert-type="user">用户消息</div>
                    <div class="context-menu-submenu-item" data-insert-type="ai">AI 消息</div>
                </div>
            </div>
        </div>
        <div class="context-menu-item" id="delete-message">
            <i class="far fa-trash-alt"></i>
            删除消息
        </div>
        <div class="context-menu-item" id="clear-chat-context" style="display: none;">
            <i class="far fa-trash"></i>
            清空聊天
        </div>
    </div>
    <div id="input-container">
        <div id="status-dot" class="status-dot" title="获取网页内容"></div>
        <div id="input-api-switcher" class="input-api-switcher">
            <div class="input-api-current" title="当前 API"></div>
            <div class="input-api-list"></div>
        </div>
        <div id="image-container"></div>
        <div id="message-row">
            <div id="message-input" contenteditable="plaintext-only" placeholder="输入消息..." role="textbox"></div>
            <button id="screenshot-button" title="截屏页面内容">
                <i class="far fa-camera"></i>
            </button>
            <button id="send-button">↵</button>
            <div id="settings-container">
                <button id="settings-button">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="6" r="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <circle cx="12" cy="18" r="2"/>
                    </svg>
                </button>
                <div id="settings-menu">
                    <div class="menu-item" id="theme-selector">
                        <div class="theme-preview-grid">
                            <!-- 动态加载主题预览卡片 -->
                        </div>
                        <select id="theme-select" class="theme-select" style="display: none;">
                            <!-- 动态加载主题选项 -->
                        </select>
                        <span class="theme-switch-container" style="display: none;">
                            <label class="switch">
                                <input type="checkbox" id="theme-switch">
                                <span class="slider"></span>
                            </label>
                            <span class="theme-switch-label">深色模式</span>
                        </span>
                        <div class="theme-title">
                            <i class="far fa-palette"></i>
                            <span>主题选择</span>
                        </div>
                    </div>
                    <div class="menu-item" id="settings-random-background">
                        <i class="far fa-image"></i>
                        <span>随机背景图片</span>
                    </div>
                    <div class="menu-item" id="dock-mode-toggle">
                        <i class="far fa-window-restore"></i>
                        <span>停靠模式</span>
                    </div>
                    <div class="menu-item" id="clear-chat" style="display: none;">
                        <span>清空聊天记录</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M3 4H13" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M5 4V12H11V4" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="menu-item" id="quick-summary" style="display: none;">
                        <span>快速总结</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M2 4h12M2 8h8M2 12h4" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="menu-item" id="favorite-apis" style="display: none;">
                        <span>收藏的API</span>
                        <div class="favorite-apis-list"></div>
                    </div>
                    <div class="menu-item" id="debug-chat-tree-btn" style="display: none;">
                        <i class="far fa-bug"></i>
                        <span>调试聊天记录树</span>
                    </div>
                    <div class="menu-item" id="fullscreen-toggle" style="display: none;">
                        <i class="far fa-expand"></i>
                        <span>全屏模式</span>
                    </div>
                    <div class="menu-item" id="open-standalone-page" style="display: none;">
                        <i class="far fa-window-maximize"></i>
                        <span>独立聊天页面</span>
                    </div>
                    <div class="menu-item" id="preferences-settings-toggle">
                        <i class="far fa-sliders"></i>
                        <span>偏好设置</span>
                    </div>
                    <div class="menu-item" id="api-settings-toggle">
                        <i class="far fa-key-skeleton"></i>
                        <span>API 设置</span>
                    </div>
                    <div class="menu-item" id="prompt-settings-toggle">
                        <i class="far fa-pen-field"></i>
                        <span>提示词设置</span>
                    </div>
                    <div class="menu-item" id="chat-history-menu">
                        <i class="far fa-history"></i>
                        <span>聊天记录</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="slash-command-hints" class="slash-command-hints" aria-hidden="true">
            <div class="slash-command-hints-header">斜杠命令</div>
            <div class="slash-command-hints-list"></div>
        </div>
    </div>
    <div id="api-settings">
        <div class="settings-header">
            <button class="back-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <span class="settings-title">API 设置</span>
        </div>
        <div class="api-cards">
            <!-- 卡片模板 -->
            <div class="api-card template" style="display: none;">
                <div class="api-card-header">
                    <div class="api-card-title"></div>
                    <div class="api-card-actions">
                        <button class="card-button drag-handle" title="拖动排序" aria-label="拖动排序" draggable="true">
                            <span class="drag-handle-icon" aria-hidden="true"></span>
                        </button>
                        <button class="card-button select-btn" title="选择">
                            <i class="far fa-check"></i>
                        </button>
                        <button class="card-button favorite-btn" title="收藏">
                            <i class="far fa-star"></i>
                        </button>
                        <button class="card-button duplicate-btn" title="复制">
                            <i class="far fa-clone"></i>
                        </button>
                        <button class="card-button delete-btn" title="删除">
                            <i class="far fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="api-form">
                    <div class="api-form-grid">
                        <div class="api-form-left">
                            <div class="form-group">
                                <div class="form-group-header">
                                    <label>API Key (逗号分隔轮询多个Key)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="password" class="api-key" placeholder="输入 API Key">
                                    <button class="toggle-password-btn" title="切换密码显示">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                            <path class="eye-slash" d="M3 3l18 18"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>API 端点 URL</label>
                                <input type="text" class="base-url" placeholder="输入 Base URL">
                            </div>
                            <div class="form-group">
                                <label>模型ID</label>
                                <input type="text" class="model-name" placeholder="输入模型名称">
                            </div>
                            <div class="form-group">
                                <label>显示名称</label>
                                <input type="text" class="display-name" placeholder="输入显示名称（可选）">
                            </div>
                            <div class="form-group">
                                <div class="form-group-header">
                                    <label>Temperature</label>
                                    <span class="temperature-value">1.0</span>
                                </div>
                                <input type="range" class="temperature" min="0" max="2" step="0.1" value="1">
                            </div>
                        </div>
                        <div class="api-form-right">
                            <div class="form-group custom-params-group">
                                <label>自定义参数</label>
                                <textarea class="custom-params" placeholder='例如: {"Authorization": "Bearer sk-...", "X-Org": "acme"}'></textarea>
                            </div>
                             <div class="form-group custom-system-prompt-group">
                                 <label>自定义提示词</label>
                                 <textarea class="custom-system-prompt" placeholder="为该 API 额外添加的系统提示词，发送时将置顶合并。"></textarea>
                             </div>
                             <div class="form-group user-message-template-group">
                                 <label>用户消息预处理模板</label>
                                 <textarea class="user-message-template" placeholder="使用 {{input}} 代表用户输入；支持 {{datetime}}/{{date}}/{{time}}；支持 {{#system}}/{{#assistant}}/{{#user}} 角色块按顺序发送"></textarea>
                                 <div class="switch-row user-message-template-options">
                                     <div class="switch-row-left">
                                         <label class="switch">
                                             <input type="checkbox" class="user-message-template-include-history">
                                             <span class="slider"></span>
                                         </label>
                                         <span class="switch-text">写入聊天记录</span>
                                     </div>
                                     <div class="user-message-template-actions">
                                         <button type="button" class="template-help-icon" aria-label="模板语法说明">?</button>
                                         <button type="button" class="template-inject-copy-btn">复制角色块</button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="api-settings-actions">
            <button type="button" class="api-add-button" id="api-add-config">+ 新增 API 配置</button>
        </div>
    </div>
    <div id="prompt-settings">
        <div class="settings-header">
            <button class="back-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <span class="settings-title">提示词设置</span>
        </div>
        <div class="prompt-settings-content">
            <section class="prompt-section" data-section="base">
                <div class="prompt-section-header">
                    <span class="prompt-section-title">基础设置</span>
                </div>
                <div class="prompt-section-body">
                    <div class="prompt-group">
                        <label>系统提示词</label>
                        <textarea id="system-prompt" placeholder="输入系统提示词..."></textarea>
                        <div class="prompt-help">
                            提示：系统提示词会与网页内容、截图提示、以及用户提示词中的 <code>{{system}}...{{end_system}}</code> 注入块合并为 system 消息；若 API 配置有“自定义系统提示词”，会置顶合并。支持 <code>{{datetime}}</code>/<code>{{date}}</code>/<code>{{time}}</code>。
                        </div>
                    </div>
                    <div class="prompt-group">
                        <label>快速总结提示词</label>
                        <textarea id="summary-prompt" placeholder="输入页面总结时使用的提示词..."></textarea>
                        <div class="prompt-help">
                            支持在提示词中写 <code>{{system}}...{{end_system}}</code> 追加系统指令（发送时会被抽出并合并到 system 消息）；支持 <code>{{datetime}}</code>/<code>{{date}}</code>/<code>{{time}}</code>。
                        </div>
                    </div>
                </div>
            </section>

            <section class="prompt-section" data-section="search">
                <div class="prompt-section-header">
                    <span class="prompt-section-title">搜索相关</span>
                </div>
                <div class="prompt-section-body">
                    <div class="prompt-group">
                        <label>划词方式1</label>
                        <textarea id="query-prompt" placeholder="输入划词方式1使用的提示词..."></textarea>
                        <div class="prompt-help">
                            使用 <code>&lt;SELECTION&gt;</code> 代表选中文本；支持 <code>{{system}}...{{end_system}}</code> 注入系统指令；支持 <code>{{datetime}}</code>/<code>{{date}}</code>/<code>{{time}}</code>。
                        </div>
                    </div>
                    <div class="prompt-group">
                        <label>划词方式2</label>
                        <textarea id="selection-prompt" placeholder="输入划词方式2使用的提示词..."></textarea>
                        <div class="prompt-help">
                            使用 <code>&lt;SELECTION&gt;</code> 代表选中文本；支持 <code>{{system}}...{{end_system}}</code> 注入系统指令；支持 <code>{{datetime}}</code>/<code>{{date}}</code>/<code>{{time}}</code>。
                        </div>
                    </div>
                </div>
            </section>

            <section class="prompt-section" data-section="url-rules">
                <div class="prompt-section-header">
                    <span class="prompt-section-title">URL 规则预设</span>
                </div>
                <div class="prompt-section-body">
                    <div class="prompt-group prompt-group--url-rules">
                        <label>URL规则预设</label>
                        <div class="url-rules-panel">
                            <div class="url-rules-composer">
                                <div class="url-rule-row">
                                    <input type="text" class="url-rule-pattern-input" placeholder="匹配 URL（支持 * 通配符）" aria-label="URL 匹配模式">
                                    <select class="url-rule-type-select" aria-label="规则类型">
                                        <option value="system">系统提示词</option>
                                        <option value="summary">快速总结提示词</option>
                                    </select>
                                    <button class="url-rule-action-btn confirm-rule" title="添加规则" type="button">添加</button>
                                </div>
                                <textarea class="url-rule-prompt" placeholder="输入提示词内容..." aria-label="规则提示词"></textarea>
                            </div>
                            <div id="url-rules-list" class="url-rules-list"></div>
                        </div>
                        <textarea id="urlRules-prompt" class="prompt-storage" aria-hidden="true"></textarea>
                    </div>
                </div>
            </section>

            <div class="prompt-actions">
                <span id="save-status" class="save-status">所有更改已保存</span>
                <button id="save-prompts">保存并关闭</button>
            </div>
        </div>
    </div>
    <div class="image-preview-modal">
        <img src="" alt="预览图片">
    </div>
    <script src="/lib/marked.min.js"></script>
    <script src="/lib/highlight.min.js"></script>
    <script src="/lib/katex.min.js"></script>
    <script src="/lib/auto-render.min.js"></script>
    <script src="/src/utils/storage_write_queue.js"></script>
    <script type="module" src="/src/ui/sidebar/sidebar.js"></script>
    <script type="module" src="/src/ui/sidebar/sidebar-message-handler.js"></script>
</body>
</html>
