name: Sync to fork

# 该工作流会在每次推送后同步同名分支与标签到指定 fork。
# 需要在当前仓库的 Secrets 中配置 CEREBR_FORK_TOKEN（目标仓库写权限的 PAT）。
# 注意：同名分支会以源仓库为准强制更新，但不会删除 fork 上的其他分支。

on:
  push:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 同步到 fork 仓库
        env:
          FORK_REPO: oyasumiaiko/Cerebr-fork
          FORK_TOKEN: ${{ secrets.CEREBR_FORK_TOKEN }}
          # 显式注入 GITHUB_TOKEN，避免 bash -u 报未定义变量。
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${FORK_TOKEN:-}" ]; then
            echo "CEREBR_FORK_TOKEN 未配置"
            exit 1
          fi

          # 使用裸仓库拉取分支与标签，避免同步到无关的 refs/pull。
          SOURCE_REPO="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git init --bare repo-mirror
          cd repo-mirror
          git remote add origin "$SOURCE_REPO"
          git fetch --prune origin "+refs/heads/*:refs/heads/*" "+refs/tags/*:refs/tags/*"

          # 仅同步同名分支与标签，不删除 fork 上的其他分支。
          FORK_REPO_URL="https://x-access-token:${FORK_TOKEN}@github.com/${FORK_REPO}.git"
          git remote add fork "$FORK_REPO_URL"
          git push --force fork "refs/heads/*:refs/heads/*" "refs/tags/*:refs/tags/*"
